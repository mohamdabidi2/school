generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id       String @id
  username String @unique
}

model Student {
  id       String  @id
  username String  @unique
  name     String
  surname  String
  email    String? @unique
  phone    String? @unique
  address  String
  img      String?

  sex                    UserSex
  createdAt              DateTime         @default(now())
  parentId               String
  parent                 Parent           @relation(fields: [parentId], references: [id])
  classId                Int
  class                  Class            @relation(fields: [classId], references: [id])
  gradeId                Int
  grade                  Grade            @relation(fields: [gradeId], references: [id])
  attendances            Attendance[]
  results                Result[]
  birthday               DateTime
  payments               Payment[]
  paymentType            PaymentType      @default(complete)
  totalAmount            Float? // Montant total à payer
  installmentType        InstallmentType? // Type d'échéance (trimestre ou mois)
  installmentCount       Int? // Nombre de tranches
  firstInstallmentAmount Float? // Montant de la première tranche
}

model Teacher {
  id       String  @id
  username String  @unique
  name     String
  surname  String
  email    String? @unique
  phone    String? @unique
  address  String
  img      String?

  sex       UserSex
  createdAt DateTime         @default(now())
  subjects  Subject[]
  lessons   Lesson[]
  classes   Class[]	@relation("ClassTeachers")
  supervisedClasses Class[] @relation("ClassSupervisor")
  birthday  DateTime
  absences  TeacherAbsence[]
  salaries  SalaryPayment[]
}

model Parent {
  id        String    @id
  username  String    @unique
  name      String
  surname   String
  email     String?   @unique
  phone     String    @unique
  address   String
  createdAt DateTime  @default(now())
  students  Student[]
}

model Grade {
  id    Int @id @default(autoincrement())
  level Int @unique

  students Student[]
  classess Class[]
}

model Class {
  id       Int    @id @default(autoincrement())
  name     String @unique
  capacity Int

  supervisorId  String?
  supervisor    Teacher?       @relation("ClassSupervisor", fields: [supervisorId], references: [id])
  teachers      Teacher[]      @relation("ClassTeachers")
  lessons       Lesson[]
  students      Student[]
  gradeId       Int
  grade         Grade          @relation(fields: [gradeId], references: [id])
  events        Event[]
  announcements Announcement[]
}

model Subject {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  teachers Teacher[]
  lessons  Lesson[]
}

model Lesson {
  id        Int      @id @default(autoincrement())
  name      String
  day       Day
  startTime DateTime
  endTime   DateTime

  subjectId   Int
  subject     Subject      @relation(fields: [subjectId], references: [id])
  classId     Int
  class       Class        @relation(fields: [classId], references: [id])
  teacherId   String
  teacher     Teacher      @relation(fields: [teacherId], references: [id])
  exams       Exam[]
  assignments Assignment[]
  attendances Attendance[]
}

model Exam {
  id        Int      @id @default(autoincrement())
  title     String
  startTime DateTime
  endTime   DateTime

  lessonId Int
  lesson   Lesson   @relation(fields: [lessonId], references: [id])
  results  Result[]
}

model Assignment {
  id        Int      @id @default(autoincrement())
  title     String
  content   String?
  startDate DateTime
  dueDate   DateTime

  lessonId Int
  lesson   Lesson   @relation(fields: [lessonId], references: [id])
  results  Result[]
}

model Result {
  id    Int @id @default(autoincrement())
  score Int

  examId       Int?
  exam         Exam?       @relation(fields: [examId], references: [id])
  assignmentId Int?
  assignment   Assignment? @relation(fields: [assignmentId], references: [id])
  studentId    String
  student      Student     @relation(fields: [studentId], references: [id])
}

model Attendance {
  id      Int      @id @default(autoincrement())
  date    DateTime
  present Boolean

  studentId String
  student   Student @relation(fields: [studentId], references: [id])
  lessonId  Int
  lesson    Lesson  @relation(fields: [lessonId], references: [id])
}

model Event {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  startTime   DateTime
  endTime     DateTime

  classId Int?
  class   Class? @relation(fields: [classId], references: [id])
}

model Announcement {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  date        DateTime

  classId Int?
  class   Class? @relation(fields: [classId], references: [id])
}

model Message {
  id          Int       @id @default(autoincrement())
  subject     String
  content     String
  createdAt   DateTime  @default(now())
  read        Boolean   @default(false)
  senderId    String
  recipientId String
  parentId    Int?
  parent      Message?  @relation("MessageReplies", fields: [parentId], references: [id])
  replies     Message[] @relation("MessageReplies")
}

model TeacherAbsence {
  id        Int      @id @default(autoincrement())
  date      DateTime
  reason    String?
  teacherId String
  teacher   Teacher  @relation(fields: [teacherId], references: [id])
}

model SalaryPayment {
  id        Int      @id @default(autoincrement())
  amount    Float
  date      DateTime @default(now())
  note      String?
  teacherId String
  teacher   Teacher  @relation(fields: [teacherId], references: [id])
}

enum UserSex {
  MALE
  FEMALE
}

enum Day {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
}

enum StaffRole {
  FINANCE
  ADMINISTRATION
  ADMINISTRATEUR
  DIRECTEUR
}

model StaffUser {
  id        Int       @id @default(autoincrement())
  username  String    @unique
  name      String
  surname   String
  email     String?   @unique
  phone     String?   @unique
  img       String?
  salary    Float?
  role      StaffRole
  clerkId   String?   @unique
  createdAt DateTime  @default(now())
}

model Payment {
  id            Int       @id @default(autoincrement())
  amount        Float
  date          DateTime  @default(now())
  trancheNumber Int?
  dueDate       DateTime? // Date d'échéance pour les paiements par tranche
  isOverdue     Boolean   @default(false) // Indique si le paiement est en retard
  paid          Boolean   @default(false)
  student       Student   @relation(fields: [studentId], references: [id])
  studentId     String
}

model Expense {
  id          Int           @id @default(autoincrement())
  title       String
  description String?
  amount      Float
  date        DateTime      @default(now())
  status      ExpenseStatus @default(PENDING)
  createdBy   String
}

enum PaymentType {
  complete
  tranche
}

enum InstallmentType {
  TRIMESTER // Par trimestre
  MONTHLY // Par mois
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  SECURITY_EVENT
}

enum NotificationType {
  info
  success
  warning
  error
}

enum NotificationPriority {
  low
  medium
  high
  urgent
}

model AuditLog {
  id           Int         @id @default(autoincrement())
  userId       String
  userName     String
  userRole     String
  action       AuditAction
  resource     String
  resourceId   String?
  details      String
  ipAddress    String?
  userAgent    String?
  timestamp    DateTime    @default(now())
  success      Boolean     @default(true)
  errorMessage String?

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([timestamp])
}

model Notification {
  id        Int                  @id @default(autoincrement())
  title     String
  message   String
  type      NotificationType     @default(info)
  priority  NotificationPriority @default(medium)
  userId    String
  isRead    Boolean              @default(false)
  actionUrl String?
  data      Json?
  createdAt DateTime             @default(now())
  readAt    DateTime?

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model ChatMessage {
  id          Int      @id @default(autoincrement())
  content     String
  senderId    String
  senderName  String
  senderRole  String
  recipientId String?
  isGroup     Boolean  @default(false)
  groupId     String?
  timestamp   DateTime @default(now())
  isRead      Boolean  @default(false)
  messageType String   @default("text")

  @@index([senderId])
  @@index([recipientId])
  @@index([timestamp])
}
